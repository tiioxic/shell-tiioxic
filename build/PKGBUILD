# Maintainer: Tiioxic

pkgname=caelestia-shell-tiioxic-git
_pkgbase=caelestia-shell
pkgver=r1094.92a71f2
pkgrel=1
pkgdesc="The desktop shell for the Caelestia Tiioxic dotfiles (fork)"
arch=('x86_64')
url="https://github.com/tiioxic/shell-tiioxic"
license=('GPL-3.0-only')

# Remplacer proprement les paquets upstream
provides=('caelestia-shell-git' 'caelestia-shell')
conflicts=('caelestia-shell-git' 'caelestia-shell')

# Dépendances (mets 'caelestia-cli-git' si tu ne veux pas forcer ton fork)
depends=(
  'quickshell-git'
  'ddcutil'
  'brightnessctl'
  'app2unit'
  'cava'
  'networkmanager'
  'lm_sensors'
  'fish'
  'aubio'
  'libpipewire'
  'glibc'
  'gcc-libs'
  'ttf-material-symbols-variable'
  'power-profiles-daemon'
  'ttf-rubik-vf'
  'ttf-cascadia-code-nerd'
  'grim'
  'swappy'
  'libqalculate'
)

makedepends=('git' 'gcc')

# On utilise HTTPS (pas besoin de clé SSH côté build)
source=("${pkgname}::git+https://github.com/tiioxic/shell-tiioxic.git")
sha256sums=('SKIP')

pkgver() {
  cd "${srcdir}/${pkgname}"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short=7 HEAD)"
}

build() {
  cd "${srcdir}/${pkgname}/assets"
  g++ $CXXFLAGS -std=c++17 -Wall -Wextra \
     -I/usr/include/pipewire-0.3 -I/usr/include/spa-0.2 -I/usr/include/aubio \
     -o beat_detector beat_detector.cpp \
     -lpipewire-0.3 -laubio $LDFLAGS
}

package() {
  cd "${srcdir}/${pkgname}"

  # binaire auxiliaire
  install -Dm755 "./assets/beat_detector" "$pkgdir/usr/lib/caelestia/beat_detector"

  # configs Quickshell (XDG system-wide, lues par défaut)
  install -dm755 "$pkgdir/etc/xdg/quickshell/caelestia"
  # on copie le contenu du repo (sauf l'exécutable déjà installé et la VCS)
  shopt -s dotglob nullglob
  for f in * .*; do
    case "$f" in
      .|..|.git|.github|assets) continue ;;
    esac
    cp -r --no-preserve=ownership "$f" "$pkgdir/etc/xdg/quickshell/caelestia/"
  done
  # on ajoute le dossier assets (sans le binaire déjà installé)
  install -dm755 "$pkgdir/etc/xdg/quickshell/caelestia/assets"
  find "assets" -maxdepth 1 -type f ! -name 'beat_detector' -exec \
    install -Dm644 '{}' "$pkgdir/etc/xdg/quickshell/caelestia/{}" \;

  # licence si présente
  if [[ -f LICENSE ]]; then
    install -Dm644 LICENSE "$pkgdir/usr/share/licenses/${pkgname}/LICENSE"
  fi
}
